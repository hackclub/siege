<% content_for :title, "Admin - Weekly Overview" %>

<% content_for :head do %>
  <style>
    .admin-container {
      max-width: 100%;
      margin: 0;
      <% if @is_ysws_review %>
      margin-left: 20rem; /* Account for navbar on YSWS review */
      <% end %>
      padding: 2rem;
    }

@media (max-width: 768px) {
  .admin-container {
    margin-left: auto;
    margin-top: 12rem; /* Position content below navbar */
  }
}
    
    .admin-header {
      margin-bottom: 2rem;
    }
    
    .admin-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #402b20;
    }
    
    .week-selector {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(64, 43, 32, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .week-selector label {
      font-weight: 600;
      color: #402b20;
      font-size: 1.1rem;
      margin-right: 1rem;
    }
    
    .week-selector select {
      padding: 0.5rem 1rem;
      border: 2px solid rgba(64, 43, 32, 0.3);
      border-radius: 6px;
      font-size: 1rem;
      background: white;
    }
    
    .users-grid {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: 1fr;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    /* Responsive grid - 2 columns max on medium+ screens */
    @media (min-width: 768px) {
      .users-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .user-card {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(64, 43, 32, 0.15);
      border-radius: 16px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .user-card:hover {
      border-color: rgba(64, 43, 32, 0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .user-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #402b20;
      margin: 0;
    }
    
    .user-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #6b5b4a;
      margin-bottom: 0.25rem;
    }
    
    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #402b20;
    }
    
    .project-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .project-status.building { background-color: #dbeafe; color: #1e40af; }
    .project-status.submitted { background-color: #d1fae5; color: #059669; }
    .project-status.pending_voting { background-color: #fef3c7; color: #d97706; }
    .project-status.finished { background-color: #e5e7eb; color: #374151; }
    
    .fraud-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 0.5rem;
    }
    
    .fraud-status.unchecked { background-color: #f3f4f6; color: #6b7280; }
    .fraud-status.sus { background-color: #fef3c7; color: #d97706; }
    .fraud-status.fraud { background-color: #fee2e2; color: #dc2626; }
    .fraud-status.good { background-color: #d1fae5; color: #059669; }
    
    .fraud-reasoning {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #f9fafb;
      border-left: 3px solid #e5e7eb;
      font-size: 0.85rem;
      font-style: italic;
      color: #6b7280;
    }
    
    .no-project {
      color: #6b5b4a;
      font-style: italic;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #6366f1;
      text-decoration: none;
      margin-bottom: 2rem;
      font-weight: 500;
    }
    
    .back-link:hover {
      color: #4f46e5;
      text-decoration: none;
    }
    
    .fraud-link {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: #6366f1;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .fraud-link:hover {
      background: #4f46e5;
      color: white;
      text-decoration: none;
      transform: translateY(-1px);
    }
    
    .clear-filters {
      background: #6b5b4a;
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: inline-block;
      transition: background 0.2s;
    }
    
    .clear-filters:hover {
      background: #5a4a3a;
      color: white;
      text-decoration: none;
    }
    
    .hide-project-btn, .unhide-project-btn {
      padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid #f59e0b;
      background-color: transparent;
      color: #f59e0b;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 0.5rem;
    }
    .hide-project-btn:hover {
      background-color: #f59e0b;
      color: white;
    }
    .unhide-project-btn {
      border-color: #10b981;
      color: #10b981;
    }
    .unhide-project-btn:hover {
      background-color: #10b981;
      color: white;
    }
    
    /* Pagination Styles */
    .pagination-container {
      margin-top: 2rem;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(64, 43, 32, 0.2);
      border-radius: 12px;
      text-align: center;
    }
    
    .pagination-info {
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #6b5b4a;
    }
    
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .pagination-link {
      padding: 0.5rem 0.75rem;
      background: #402b20;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .pagination-link:hover {
      background: #2d1e16;
      transform: translateY(-1px);
    }
    
    .pagination-current {
      padding: 0.5rem 0.75rem;
      background: #059669;
      color: white;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .pagination-ellipsis {
      padding: 0.5rem 0.5rem;
      color: #6b5b4a;
      font-weight: 500;
    }
    
    .refresh-cache-btn {
      padding: 0.75rem 1.5rem;
      background: #059669;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    
    .refresh-cache-btn:hover {
      background: #047857;
      transform: translateY(-1px);
    }
  </style>
<% end %>

<div class="admin-container">


  <div class="admin-header">
    <h1 class="admin-title">Weekly Overview</h1>
  </div>

  <% if @is_ysws_review && @airtable_leaderboard&.any? %>
    <div style="background: rgba(255, 255, 255, 0.95); border: 2px solid rgba(64, 43, 32, 0.15); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
      <h2 style="font-size: 1.5rem; font-weight: 700; color: #402b20; margin-bottom: 1rem;">
        Review leaderboard
      </h2>
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: rgba(64, 43, 32, 0.05); border-bottom: 2px solid rgba(64, 43, 32, 0.2);">
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #402b20;">Rank</th>
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #402b20;">Reviewer</th>
            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #402b20;">Submissions</th>
          </tr>
        </thead>
        <tbody>
          <% @airtable_leaderboard.each_with_index do |entry, index| %>
            <tr style="border-bottom: 1px solid rgba(64, 43, 32, 0.1); <%= 'background: rgba(255, 215, 0, 0.1);' if index == 0 %>">
              <td style="padding: 0.75rem; font-weight: <%= index < 3 ? '700' : '500' %>; color: <%= index == 0 ? '#d97706' : (index == 1 ? '#6b7280' : (index == 2 ? '#92400e' : '#402b20')) %>;">
                <%= index + 1 %>
              </td>
              <td style="padding: 0.75rem;">
                <% user = User.find_by(id: entry[:reviewer_id]) %>
                <% if user %>
                  <%= link_to entry[:reviewer_name], admin_user_details_path(user), style: "color: #2563eb; text-decoration: none; font-weight: 600;" %>
                <% else %>
                  <span style="font-weight: 600; color: #402b20;"><%= entry[:reviewer_name] %></span>
                <% end %>
              </td>
              <td style="padding: 0.75rem; text-align: center;">
                <span style="display: inline-block; background: <%= index == 0 ? '#059669' : '#6366f1' %>; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 600; font-size: 0.9rem;">
                  <%= entry[:submission_count] %>
                </span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <div class="week-selector">
    <%= form_with url: (@is_ysws_review ? ysws_review_path : admin_weekly_overview_path), method: :get, local: true do |form| %>
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <%= form.label :week, "Select Week:" %>
        <%= form.select :week, 
            options_for_select(@available_weeks.map { |w| ["Week #{w}", w] }, @selected_week),
            {},
            { onchange: "this.form.submit();" } %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <%= form.label :user_status, "Filter by User Status:" %>
        <%= form.select :user_status,
            options_for_select([
              ['All User Statuses', 'all'],
              ['New', 'new'],
              ['Working', 'working'],
              ['Out', 'out'],
              ['Banned', 'banned']
            ], @user_status_filter),
            {},
            { onchange: "this.form.submit();" } %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
        <%= form.label :status, "Filter by Project Status:" %>
        <%= form.select :status,
            options_for_select([
              ['All Statuses', 'all'],
              ['Pending Voting & Waiting for Finalization', 'pending_voting_and_waiting'],
              ['Building', 'building'],
              ['Submitted', 'submitted'],
              ['Pending Voting', 'pending_voting'],
              ['Waiting for Finalization', 'waiting_for_review'],
              ['Finished', 'finished'],
              ['No Project', 'no_project']
            ], @status_filter),
            {},
            { onchange: "this.form.submit();" } %>
      </div>
      
      <% if current_user&.can_access_fraud_dashboard? %>
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
          <%= form.label :fraud_status, "Filter by Fraud Status:" %>
          <%= form.select :fraud_status,
              options_for_select([
                ['All Fraud Statuses', ''],
                ['Good & Unchecked (Default)', 'good_and_unchecked'],
                ['Unchecked', 'unchecked'],
                ['Suspicious', 'sus'],
                ['Confirmed Fraud', 'fraud'],
                ['Good/Verified', 'good']
              ], @fraud_status_filter),
              {},
              { onchange: "this.form.submit();" } %>
        </div>
      <% end %>
      
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
        <%= form.label :airtable_status, "Filter by Airtable Status:" %>
        <%= form.select :airtable_status,
            options_for_select([
              ['All', 'all'],
              ['Not Submitted (Default)', 'not_submitted'],
              ['Submitted', 'submitted']
            ], @airtable_status_filter),
            {},
            { onchange: "this.form.submit();" } %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
        <%= form.check_box :show_hidden, { checked: @show_hidden, onchange: "this.form.submit();" }, "1", "0" %>
        <%= form.label :show_hidden, "Show hidden projects", style: "margin-left: 0.5rem;" %>
      </div>
      
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
        <%= form.label :user_search, "Search User:" %>
        <%= form.text_field :user_search, value: params[:user_search], placeholder: "Name, display name, or Slack ID", style: "padding: 0.5rem; border: 2px solid rgba(64, 43, 32, 0.3); border-radius: 6px; font-size: 0.9rem;" %>
        <%= form.label :project_search, "Search Project:", style: "margin-left: 1rem;" %>
        <%= form.text_field :project_search, value: params[:project_search], placeholder: "Project name", style: "padding: 0.5rem; border: 2px solid rgba(64, 43, 32, 0.3); border-radius: 6px; font-size: 0.9rem;" %>
        <%= form.submit "Search", style: "padding: 0.5rem 1rem; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" %>
      </div>
      
      <div style="margin-top: 1rem;">
        <% 
          current_week = current_week_number
          previous_week = current_week - 1
          is_non_default_week = params[:week].present? && params[:week].to_i != previous_week
          is_non_default_user_status = params[:user_status].present? && params[:user_status] != 'all'
          is_non_default_status = params[:status].present? && params[:status] != 'pending_voting_and_waiting'
          is_non_default_fraud = current_user&.can_access_fraud_dashboard? && params[:fraud_status].present? && params[:fraud_status] != 'good_and_unchecked'
          is_non_default_airtable = params[:airtable_status].present? && params[:airtable_status] != 'not_submitted'
          is_non_default_hidden = params[:show_hidden] == "1"
        %>
        <% if is_non_default_week || is_non_default_user_status || is_non_default_status || is_non_default_fraud || is_non_default_airtable || is_non_default_hidden %>
          <%= link_to "Reset to Defaults", (@is_ysws_review ? ysws_review_path : admin_weekly_overview_path), class: "clear-filters" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Randomize Toggle -->
  <div style="margin-bottom: 1rem;">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 1rem; font-weight: 500; color: #402b20;">
      <input type="checkbox" id="randomize-toggle" checked style="width: 18px; height: 18px; cursor: pointer;">
      <span>Randomize Order</span>
    </label>
  </div>

  <!-- Users Count -->
  <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #6b5b4a;">
    Showing <%= @user_data.count %> user<%= @user_data.count == 1 ? '' : 's' %>
    <% if params[:user_status].present? && params[:user_status] != 'all' %>
      with <%= params[:user_status] %> user status
    <% end %>
    <% if params[:status].present? && params[:status] != 'all' %>
      <%= params[:user_status].present? && params[:user_status] != 'all' ? 'and' : 'with' %> <%= params[:status] == 'no_project' ? 'no project' : params[:status] %> project status
    <% end %>
    <% if params[:fraud_status].present? && params[:fraud_status] != '' %>
      and <%= params[:fraud_status] %> fraud status
    <% end %>
    <% if @show_hidden %>
      (including hidden projects)
    <% end %>
    for week <%= @selected_week %>
    <% if @total_pages > 1 %>
      (Page <%= @current_page %> of <%= @total_pages %>)
    <% end %>
  </div>

  <div class="users-grid">
    <% if @user_data.any? %>
      <% @user_data.each do |user_id, data| %>
        <div class="user-card" onclick="window.location.href='<%= @is_ysws_review ? ysws_review_user_path(@selected_week, user_id) : admin_weekly_overview_user_path(@selected_week, user_id) %>'">
          <div class="user-header">
            <h3 class="user-name">
              <%= data[:user].name %>
              <% if data[:user].display_name.present? && data[:user].display_name != data[:user].name %>
                <span style="color: #666; font-weight: normal;">(<%= data[:user].display_name %>)</span>
              <% end %>
            </h3>
            <% if data[:project] %>
              <div>
                <span class="project-status <%= data[:project].status %>">
                  <%= data[:project].status.humanize %>
                </span>
                <% if data[:fraud_status] %>
                  <span class="fraud-status <%= data[:fraud_status] %>">
                    <%= data[:fraud_status] %>
                  </span>
                <% end %>
                <% if data[:project].reviewer_video.attached? %>
                  <span style="background: #8b5cf6; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: 0.25rem;" title="Has review video">
                    📹
                  </span>
                <% end %>
              </div>
            <% else %>
              <span class="no-project">No Project</span>
            <% end %>
          </div>
          
          <% if data[:project] %>
            <div class="project-info">
              <strong>Project:</strong> <%= data[:project].name %>
            </div>
            <% if data[:fraud_reasoning].present? %>
              <div class="fraud-reasoning">
                <strong>Fraud Reasoning:</strong> <%= data[:fraud_reasoning] %>
              </div>
            <% end %>
          <% end %>
          
          <div class="user-stats">
            <div class="stat-item">
              <div class="stat-label">Time Spent</div>
              <div class="stat-value">
                <%= data[:time_readable] %>
                <% if data[:mercenary_count] && data[:mercenary_count] > 0 %>
                  <div style="font-size: 0.8rem; color: #8b4513; margin-top: 0.25rem;">🪖 <%= data[:mercenary_count] %> (Goal: <%= data[:effective_hour_goal] %>h)</div>
                <% end %>
              </div>
            </div>
            
            <% if data[:average_score] %>
              <div class="stat-item">
                <div class="stat-label">Average Score</div>
                <div class="stat-value"><%= data[:average_score] %> / 5</div>
              </div>
            <% end %>
            
            <div class="stat-item">
              <div class="stat-label">Balance</div>
              <div class="stat-value"><%= data[:user].coins || 0 %> coins</div>
            </div>
            
            <div class="stat-item">
              <div class="stat-label">Slack ID</div>
              <div class="stat-value"><%= data[:user].slack_id %></div>
            </div>
          </div>
          
          <% if data[:user].slack_id.present? %>
            <div style="margin-top: 1rem; text-align: center;">
              <a href="https://dash.fraud.land/profile/<%= data[:user].slack_id %>" target="_blank" class="fraud-link" onclick="event.stopPropagation();">
                View Fraud.land Profile
              </a>
            </div>
          <% end %>
          
          <% if current_user&.super_admin? && data[:project] && !@is_ysws_review %>
            <div style="margin-top: 1rem; text-align: center;">
              <% if data[:project].hidden? %>
                <%= button_to "Unhide Project", admin_unhide_project_path(data[:project]),
                    method: :patch,
                    class: "unhide-project-btn",
                    style: "margin-right: 0.5rem;",
                    onclick: "event.stopPropagation();" %>
              <% else %>
                <%= button_to "Hide Project", admin_hide_project_path(data[:project]),
                    method: :patch,
                    class: "hide-project-btn",
                    style: "margin-right: 0.5rem;",
                    onclick: "event.stopPropagation();" %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div style="text-align: center; padding: 3rem; color: #6b5b4a;">
        <h3>No users found for week <%= @selected_week %></h3>
        <p>Either no users are active this week or the week range is invalid.</p>
      </div>
    <% end %>
    
    <!-- Pagination -->
    <% if @total_pages > 1 %>
      <div class="pagination-container">
        <div class="pagination-info">
          Showing <%= (@current_page - 1) * @per_page + 1 %> to <%= [@current_page * @per_page, @total_users].min %> of <%= @total_users %> users
        </div>
        <div class="pagination-controls">
          <% 
            base_path = @is_ysws_review ? :ysws_review_path : :admin_weekly_overview_path
            pagination_params = { week: @selected_week, user_status: params[:user_status], status: params[:status], fraud_status: params[:fraud_status], airtable_status: params[:airtable_status], user_search: params[:user_search], project_search: params[:project_search] }
          %>
          <% if @current_page > 1 %>
            <%= link_to "← Previous", send(base_path, pagination_params.merge(page: @current_page - 1)), class: "pagination-link" %>
          <% end %>
          
          <% @total_pages.times do |page_num| %>
            <% page_num = page_num + 1 %>
            <% if page_num == @current_page %>
              <span class="pagination-current"><%= page_num %></span>
            <% elsif page_num == 1 || page_num == @total_pages || (page_num >= @current_page - 2 && page_num <= @current_page + 2) %>
              <%= link_to page_num, send(base_path, pagination_params.merge(page: page_num)), class: "pagination-link" %>
            <% elsif page_num == @current_page - 3 || page_num == @current_page + 3 %>
              <span class="pagination-ellipsis">...</span>
            <% end %>
          <% end %>
          
          <% if @current_page < @total_pages %>
            <%= link_to "Next →", send(base_path, pagination_params.merge(page: @current_page + 1)), class: "pagination-link" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
(function() {
  const usersGrid = document.querySelector('.users-grid');
  const randomizeToggle = document.getElementById('randomize-toggle');
  
  if (!usersGrid || !randomizeToggle) return;
  
  // Store original order
  let originalCards = Array.from(usersGrid.children);
  let currentlyRandomized = false;
  
  // Fisher-Yates shuffle algorithm
  function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }
  
  function randomizeUsers() {
    const cards = Array.from(usersGrid.children);
    const shuffled = shuffleArray(cards);
    
    // Clear and re-append in random order
    usersGrid.innerHTML = '';
    shuffled.forEach(card => usersGrid.appendChild(card));
    currentlyRandomized = true;
  }
  
  function restoreOriginalOrder() {
    usersGrid.innerHTML = '';
    originalCards.forEach(card => usersGrid.appendChild(card));
    currentlyRandomized = false;
  }
  
  // Randomize on page load (since toggle is checked by default)
  randomizeUsers();
  
  // Toggle randomization when checkbox changes
  randomizeToggle.addEventListener('change', function() {
    if (this.checked) {
      randomizeUsers();
    } else {
      restoreOriginalOrder();
    }
  });
})();
</script>
