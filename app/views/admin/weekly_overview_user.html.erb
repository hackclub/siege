<% content_for :title, "Admin - Weekly Overview - #{@user.name}" %>

<% content_for :head do %>
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #6366f1;
      text-decoration: none;
      margin-bottom: 2rem;
      font-weight: 500;
    }
    
    .back-link:hover {
      color: #4f46e5;
      text-decoration: none;
    }
    
    .page-header {
      margin-bottom: 2rem;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #402b20;
    }
    
    .page-subtitle {
      font-size: 1.1rem;
      color: #6b5b4a;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(64, 43, 32, 0.15);
      border-radius: 16px;
      padding: 1.5rem;
    }
    
    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #402b20;
    }
    
    .user-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 0.9rem;
      color: #6b5b4a;
      margin-bottom: 0.25rem;
    }
    
    .info-value {
      font-weight: 600;
      color: #402b20;
    }
    
    .project-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .project-status.building { background-color: #dbeafe; color: #1e40af; }
    .project-status.submitted { background-color: #d1fae5; color: #059669; }
    .project-status.pending_voting { background-color: #fef3c7; color: #d97706; }
    .project-status.finished { background-color: #e5e7eb; color: #374151; }
    
    .fraud-status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .fraud-status.unchecked { background-color: #fbbf24; color: #92400e; }
    .fraud-status.sus { background-color: #f59e0b; color: white; }
    .fraud-status.fraud { background-color: #dc2626; color: white; }
    .fraud-status.good { background-color: #059669; color: white; }
    
    .votes-list {
      margin-top: 1rem;
    }
    
    .vote-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(64, 43, 32, 0.1);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .vote-user {
      font-weight: 600;
      color: #402b20;
    }
    
    .vote-score {
      font-weight: 700;
      color: #d97706;
    }
    
    .ballot-link {
      color: #6366f1;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .ballot-link:hover {
      text-decoration: underline;
    }
    
         .review-panel, .user-management-panel {
       background: rgba(255, 248, 220, 0.8);
       border: 2px solid rgba(217, 119, 6, 0.3);
       border-radius: 16px;
       padding: 1.5rem;
     }
     
     .user-management-panel {
       background: rgba(220, 248, 255, 0.8);
       border: 2px solid rgba(6, 119, 217, 0.3);
     }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #402b20;
      margin-bottom: 0.5rem;
    }
    
    .form-input, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid rgba(64, 43, 32, 0.3);
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .submit-button {
      background: #d97706;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .submit-button:hover {
      background: #b45309;
    }
    
    .submit-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .submitted-notice {
      background: #d1fae5;
      border: 2px solid #059669;
      border-radius: 8px;
      padding: 1rem;
      color: #059669;
      font-weight: 600;
      text-align: center;
    }
    
         .no-project-notice {
       background: #fee2e2;
       border: 2px solid #dc2626;
       border-radius: 8px;
       padding: 1rem;
       color: #dc2626;
       font-weight: 600;
       text-align: center;
     }
     
     .toggle-switch {
       position: relative;
       display: inline-block;
       width: 50px;
       height: 24px;
     }
     
     .toggle-switch input {
       opacity: 0;
       width: 0;
       height: 0;
     }
     
     .toggle-slider {
       position: absolute;
       cursor: pointer;
       top: 0;
       left: 0;
       right: 0;
       bottom: 0;
       background-color: #ccc;
       transition: .4s;
       border-radius: 24px;
     }
     
     .toggle-slider:before {
       position: absolute;
       content: "";
       height: 18px;
       width: 18px;
       left: 3px;
       bottom: 3px;
       background-color: white;
       transition: .4s;
       border-radius: 50%;
     }
     
     input:checked + .toggle-slider {
       background-color: #d97706;
     }
     
     input:checked + .toggle-slider:before {
       transform: translateX(26px);
     }
     
    .fraud-link {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: #6366f1;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .fraud-link:hover {
    background: #4f46e5;
    color: white;
    text-decoration: none;
    transform: translateY(-1px);
    }
     
     .reviewer-feedback-section {
       margin-top: 2rem;
       padding-top: 1.5rem;
       border-top: 2px solid rgba(217, 119, 6, 0.2);
     }
     
     .reviewer-feedback-description {
       color: #6b5b4a;
       margin-bottom: 1.5rem;
     }
     
     .reviewer-feedback-textarea {
       min-height: 120px;
     }
     
     .reviewer-feedback-help {
       color: #6b5b4a;
       font-size: 0.8rem;
       margin-top: 0.5rem;
       display: block;
     }
  </style>
<% end %>

<div class="admin-container">
  <%= link_to admin_weekly_overview_path(week: @selected_week), class: "back-link" do %>
    ‚Üê Back to Weekly Overview
  <% end %>

  <div class="page-header">
    <h1 class="page-title"><%= @user.name %></h1>
    <p class="page-subtitle">Week <%= @selected_week %> Details</p>
  </div>

  <% if @project %>
    <div class="content-grid">
      <!-- Project & Voting Information -->
      <div class="card">
        <h2 class="card-title">Project Information</h2>
        
        <div class="user-info">
          <div class="info-item">
            <span class="info-label">Project Name</span>
            <span class="info-value"><%= @project.name %></span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="project-status <%= @project.status %>">
              <%= @project.status.humanize %>
            </span>
          </div>
          
          <% if current_user&.can_access_fraud_dashboard? %>
            <div class="info-item">
              <span class="info-label">Fraud Status</span>
              <span class="fraud-status <%= @project.fraud_status %>">
                <%= @project.fraud_status.humanize %>
              </span>
            </div>
          <% end %>
          
          <div class="info-item">
            <span class="info-label">Time Spent</span>
            <span class="info-value"><%= @time_readable %></span>
          </div>
          
          <% if @average_score %>
            <div class="info-item">
              <span class="info-label">Average Score</span>
              <span class="info-value"><%= @average_score %> / 5</span>
            </div>
          <% end %>
          
          <div class="info-item">
            <span class="info-label">Repository</span>
            <span class="info-value">
              <% if @project.repo_url.present? %>
                <a href="<%= @project.repo_url %>" target="_blank" style="color: #6366f1;">
                  <%= @project.repo_url.split('/').last %>
                </a>
              <% else %>
                Not provided
              <% end %>
            </span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Demo URL</span>
            <span class="info-value">
              <% if @project.demo_url.present? %>
                <a href="<%= @project.demo_url %>" target="_blank" style="color: #6366f1;">
                  View Demo
                </a>
              <% else %>
                Not provided
              <% end %>
            </span>
          </div>
        </div>

        <% if @project.description.present? %>
          <div style="margin-top: 1rem;">
            <span class="info-label">Description</span>
            <p style="margin-top: 0.5rem; color: #402b20;"><%= @project.description %></p>
          </div>
        <% end %>

        <% if @votes.any? %>
          <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: #402b20;">Votes Received</h3>
          <div class="votes-list">
            <% @votes.each do |vote| %>
              <div class="vote-item" style="<%= vote.voted? ? '' : 'opacity: 0.6;' %>">
                <div>
                  <span class="vote-user"><%= vote.ballot.user.name %></span>
                  <br>
                  <span class="ballot-link">
                    <%= link_to "View Ballot", admin_ballot_details_path(vote.ballot), target: "_blank" %>
                  </span>
                  <% unless vote.voted? %>
                    <br>
                    <span style="color: #dc2626; font-size: 0.8rem; font-style: italic;">(Not cast)</span>
                  <% end %>
                </div>
                <span class="vote-score">
                  <% if vote.voted? %>
                    <%= vote.star_count %> / 5
                  <% else %>
                    <span style="color: #6b7280; font-style: italic;">Not voted</span>
                  <% end %>
                </span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- User Information -->
      <div class="card">
        <h2 class="card-title">User Information</h2>
        
        <div class="user-info">
          <div class="info-item">
            <span class="info-label">Email</span>
            <span class="info-value"><%= @user.email || "Not provided" %></span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Slack ID</span>
            <span class="info-value"><%= @user.slack_id %></span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Balance</span>
            <span class="info-value"><%= @user.coins || 0 %> coins</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Rank</span>
            <span class="info-value"><%= @user.rank.humanize %></span>
          </div>
          
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value"><%= @user.status.humanize %></span>
          </div>
        </div>
        
        <% if @user.slack_id.present? %>
          <div style="margin-top: 1rem; text-align: center;">
            <a href="https://dash.fraud.land/profile/<%= @user.slack_id %>" target="_blank" class="fraud-link">
              View Fraud.land Profile
            </a>
          </div>
        <% end %>

        <% if @address %>
          <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #402b20;">Address Information</h3>
          <div class="user-info">
            <div class="info-item">
              <span class="info-label">Name</span>
              <span class="info-value"><%= @address.first_name %> <%= @address.last_name %></span>
            </div>
            
            <div class="info-item">
              <span class="info-label">Shipping Name</span>
              <span class="info-value"><%= @address.shipping_name || "Not provided" %></span>
            </div>
            
            <div class="info-item">
              <span class="info-label">Address</span>
              <span class="info-value">
                <%= @address.line_one %><br>
                <% if @address.line_two.present? %>
                  <%= @address.line_two %><br>
                <% end %>
                <%= @address.city %>, <%= @address.state %> <%= @address.postcode %><br>
                <%= @address.country %>
              </span>
            </div>
            
            <div class="info-item">
              <span class="info-label">Birthday</span>
              <span class="info-value"><%= @address.birthday || "Not provided" %></span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Admin Panels Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
      
      <!-- Admin Review Panel -->
      <div class="review-panel">
        <% if @submitted_to_airtable %>
          <div class="submitted-notice">
            ‚úì This project has already been submitted to Airtable
          </div>
        <% else %>
          <h2 class="card-title">Admin Review Panel</h2>
          <p style="color: #6b5b4a; margin-bottom: 1.5rem;">
            Review this project and submit it to Airtable with optional hour override and comments.
          </p>

          <%= form_with url: admin_submit_to_airtable_path(@selected_week, @user.id), method: :post, local: true do |form| %>
            <div class="form-group">
              <%= form.label :hour_override, "Hour Override (optional):", class: "form-label" %>
              <%= form.number_field :hour_override, step: "any", min: 0, value: @raw_hours, placeholder: "Leave blank for no override", class: "form-input" %>
            </div>

            <div class="form-group">
              <%= form.label :justification, "Justification/Comments:", class: "form-label" %>
              <%= form.text_area :justification, placeholder: "Add any comments or justification for this submission...", class: "form-textarea" %>
            </div>

            <%= form.submit "Submit to Airtable", class: "submit-button" %>
          <% end %>
        <% end %>

        <!-- Reviewer Feedback Section -->
        <div class="reviewer-feedback-section">
          <h3 class="card-title">Reviewer Feedback</h3>
          <p class="reviewer-feedback-description">
            Add feedback for the project creator. This will only be visible to them once the project is finished.
          </p>

          <div class="form-group">
            <label class="form-label">Feedback for <%= @user.name %>:</label>
            <textarea id="reviewer-feedback" class="form-textarea reviewer-feedback-textarea" placeholder="Add feedback for the project creator..."><%= @project.reviewer_feedback %></textarea>
            <small class="reviewer-feedback-help">
              This feedback will be shown to the user only when the project status is "finished".
            </small>
          </div>

          <button type="button" onclick="updateReviewerFeedback()" class="submit-button">
            Save Reviewer Feedback
          </button>
        </div>
      </div>

      <!-- User Management Panel -->
      <div class="user-management-panel">
        <h2 class="card-title">User Management</h2>
        <p style="color: #6b5b4a; margin-bottom: 1.5rem;">
          Manage user coin balance and status.
        </p>

        <div class="form-group">
          <label class="form-label">Reviewer Multiplier:</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="number" id="reviewer-multiplier" value="2" min="0" step="0.1" class="form-input" style="flex: 1;" placeholder="Reviewer multiplier (default: 2)" oninput="updateSuggestedCoins()">
            <button type="button" onclick="resetToCalculated()" class="submit-button" style="white-space: nowrap; background: #6366f1; font-size: 0.8rem; padding: 0.5rem;">Reset</button>
          </div>
          <small style="color: #6b5b4a; font-size: 0.8rem;">
            This multiplier affects the suggested coin calculation. Use Reset to recalculate if manually edited.
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">Add/Remove Coins:</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="number" id="coin-balance" value="<%= @suggested_coins * 2 %>" class="form-input" style="flex: 1;" placeholder="Enter amount to add/subtract" oninput="markAsManuallyEdited()">
            <button type="button" onclick="updateCoins()" class="submit-button" style="white-space: nowrap;">Add/Remove Coins</button>
          </div>
          <small style="color: #6b5b4a; font-size: 0.8rem;">
            <span id="coin-calculation-display">
              User balance: <span id="current-user-balance"><%= @user.coins || 0 %></span> coins | Project value: <span id="current-project-value"><%= @project&.coin_value || 0 %></span> coins<br>
              Suggested: <span id="suggested-coins-display"><%= @suggested_coins * 2 %></span> coins (<%= @raw_hours %>h √ó <%= @average_score || 0 %> avg score √ó <span id="multiplier-display">2</span> multiplier)
            </span>
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">Project Status:</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <select id="project-status-select" onchange="updateProjectStatus(this.value)" style="background: white; border: 1px solid #ccc; padding: 4px; border-radius: 4px;">
              <option value="building" <%= 'selected' if @project&.status == 'building' %>>Building</option>
              <option value="submitted" <%= 'selected' if @project&.status == 'submitted' %>>Submitted</option>
              <option value="pending_voting" <%= 'selected' if @project&.status == 'pending_voting' %>>Pending Voting</option>
              <option value="finished" <%= 'selected' if @project&.status == 'finished' %>>Finished</option>
            </select>
            <span style="color: #6b5b4a; font-size: 0.9rem;">
              Current: <span class="project-status <%= @project&.status %>"><%= @project&.status&.humanize || 'N/A' %></span>
            </span>
          </div>
          <small style="color: #6b5b4a; font-size: 0.8rem;">
            Projects must be marked as "finished" for users to see reviewer feedback.
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">User Status:</label>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <select id="status-select" onchange="updateUserStatus(this.value)" style="background: white; border: 1px solid #ccc; padding: 4px; border-radius: 4px;">
              <option value="working" <%= 'selected' if @user.status == 'working' %>>Working</option>
              <option value="out" <%= 'selected' if @user.status == 'out' %>>Out</option>
              <option value="banned" <%= 'selected' if @user.status == 'banned' %>>Banned</option>
              <option value="new" <%= 'selected' if @user.status == 'new' %>>New</option>
            </select>
            <span style="color: #6b5b4a; font-size: 0.9rem;">
              <%= case @user.status
                  when 'banned' then 'User is banned'
                  when 'out' then 'User is marked as out (siege failed)'
                  when 'working' then 'User is active'
                  when 'new' then 'User is new (not through welcome)'
                  else @user.status.humanize
                  end %>
            </span>
          </div>
          <small style="color: #6b5b4a; font-size: 0.8rem;">
            When marked as out, users cannot create or submit projects.
          </small>
        </div>
      </div>
    </div>

    <script>
      let isManuallyEdited = false;
      const baseHours = <%= @raw_hours %>;
      const averageScore = <%= @average_score || 0 %>;
      const baseSuggestedCoins = <%= @suggested_coins %>;

      function updateSuggestedCoins() {
        if (isManuallyEdited) return; // Don't update if user manually edited
        
        const multiplier = parseFloat(document.getElementById('reviewer-multiplier').value) || 0;
        const suggestedCoins = Math.round(baseSuggestedCoins * multiplier);
        
        document.getElementById('coin-balance').value = suggestedCoins;
        document.getElementById('suggested-coins-display').textContent = suggestedCoins;
        document.getElementById('multiplier-display').textContent = multiplier;
      }

      function markAsManuallyEdited() {
        isManuallyEdited = true;
        // Update multiplier display to reflect current values
        const multiplier = parseFloat(document.getElementById('reviewer-multiplier').value) || 0;
        document.getElementById('multiplier-display').textContent = multiplier;
      }

      function resetToCalculated() {
        isManuallyEdited = false;
        updateSuggestedCoins();
      }

      function updateReviewerFeedback() {
        const feedback = document.getElementById('reviewer-feedback').value;
        
        fetch('<%= admin_update_reviewer_feedback_path(@selected_week, @user.id) %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ 
            reviewer_feedback: feedback,
            week: <%= @selected_week %>
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Reviewer feedback updated successfully!');
          } else {
            alert('Error updating reviewer feedback: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating reviewer feedback. Please try again.');
        });
      }

      function updateCoins() {
        const coinBalance = document.getElementById('coin-balance').value;
        
        fetch('<%= admin_update_user_coins_path(@selected_week, @user.id) %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ 
            coins: coinBalance,
            week: <%= @selected_week %>
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the balance indicators
            if (data.new_user_balance !== undefined) {
              document.getElementById('current-user-balance').textContent = data.new_user_balance;
            }
            if (data.new_project_coin_value !== undefined) {
              document.getElementById('current-project-value').textContent = data.new_project_coin_value;
            }
            alert('Coin balance updated successfully!');
          } else {
            alert('Error updating coin balance: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating coin balance. Please try again.');
        });
      }

      function updateProjectStatus(newStatus) {
        if (confirm(`Are you sure you want to update the project status to ${newStatus}?`)) {
          fetch('<%= admin_update_project_status_path(@selected_week, @user.id) %>', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ 
              status: newStatus,
              week: <%= @selected_week %>
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Project status updated successfully!');
              location.reload(); // Reload to update the status display
            } else {
              alert('Error updating project status: ' + (data.error || 'Unknown error'));
              // Revert the select
              location.reload();
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error updating project status. Please try again.');
            // Revert the select
            location.reload();
          });
        } else {
          // Revert the select if user cancels
          location.reload();
        }
      }

      function updateOutStatus(isOut) {
        const action = isOut ? 'set_out' : 'set_active';
        const message = isOut ? 
          'Are you sure you want to mark this user as out? They will not be able to create or submit projects.' :
          'Are you sure you want to mark this user as active? They will be able to create and submit projects again.';
          
        if (confirm(message)) {
          fetch(`/admin/users/${<%= @user.id %>}/${action}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error updating user status: ' + (data.error || 'Unknown error'));
              // Revert the toggle
              document.getElementById('out-status').checked = !isOut;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error updating user status. Please try again.');
            // Revert the toggle
            document.getElementById('out-status').checked = !isOut;
          });
        } else {
          // Revert the toggle if user cancels
          document.getElementById('out-status').checked = !isOut;
        }
      }
    </script>

  <% else %>
    <div class="no-project-notice">
      No project found for <%= @user.name %> in week <%= @selected_week %>
    </div>
  <% end %>
</div>
